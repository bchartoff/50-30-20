<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82535105-3', 'auto');
  ga('send', 'pageview');

</script>



    <title>50-30-20</title>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="css/foundation.css">
    <link rel="stylesheet" href="css/app.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700" rel="stylesheet">

    <style>

      .scenario, .ideal, .actual, .needs {
        border-top:solid #010101 3px;
        border-bottom:solid #010101 3px;
      }

      .scenario {
        margin-top:1em;
        padding:0 0.935rem;
      }

      .ideal, .actual {
        background:#e8e8e8;
      }

      .needs {
        background:#d1d3d4;
      }
      
      .row {
        margin-bottom:1em;
      }

      h1, h2, h3, p, li, svg text {
        font-family: 'Roboto Condensed', sans-serif;
        color: #231f20;}


      h1 {font-weight:400; font-size:4.0em;}
      h2 {font-weight:300; font-size:3.2em; margin:0.4em 0 0.1em 0;}
      h3 {font-weight:700; font-size:1.2em; text-align:left;}
      p, li {font-weight:400; font-size:1.2em;}

      .scenario p {margin: 0; text-align:left;}
      .blue {font-weight:700; font-size:33px; line-height: 43px; color:#00a79d;} 
      .money-label {font-weight:400; font-size:0.5em; color:#231f20;}
      .graph-label {font-weight:400; font-size:1.7em; color:#231f20;}
      .actual-label {font-weight:400; font-size:1.8em; color:#231f20;}
      .needs-label {font-weight:400; font-size:1.5em; color:#231f20;}

      img {display: block; margin: 0.5em auto 1em auto;}

      .left {float:left;}
      .right {float:right;}
      .clear {clear:both;}

      div#graph-ideal, div#graph-needs {margin-bottom: 40px;}

      /* -- nice gradient, sad to lose
      div#graph-needs svg {
        background: linear-gradient(to right, rgba(258,188,80,0.2), rgba(171,73,73,0.2));}
      */

      /* TODO: convert from linear gradient to discreet background for each line, maybe draw in d3? */

      div.scenario div div {padding:0 4em 2em 4em;} /* width of column contents in scenario section */


    </style>


  </head>
  <body>

    <!-- http://foundation.zurb.com/sites/docs/grid.html -->

    <div class="row scenario">
          <h2>Scenario:</h2>
      <div class="row">
        <div class="small-12 medium-4 large-4 columns">
          <h3>LOCATION:</h3>
          <select name="location" id="location">
            <option value="balt">Baltimore, MD</option>
          </select>
          <img class="map" src="./img/map.png" />
          <p>Population: 622,793 
          <p>Area: 92.98 mi&sup2;</p>
        </div>
        <div class="small-12 medium-4 large-4 columns">
          <h3>HOUSEHOLD:</h3>
          <select name="household" id="household">
            <option value="family">2 adults 2 children</option>
          </select>
          <img class="fam" src="./img/fam.png" />
          <p>Family of 4. Both adults work.</p>
          <p>One child is 4, the other is 8.</p>
        </div>
        <div class="small-12 medium-4 large-4 columns">
          <h3>INCOME LEVEL:</h3>
          <select name="level" id="level">
            <option value="average">Average</option>
          </select>
          <p class="blue">$69,402</p>
          <p class="blue">$4,577<span class="money-label">/month</span></p>
          <p>$45,552 above federal poverty level.</p>
        </div>
      </div>
  </div>


    <div class="row ideal">
      <div class="small-12 medium-12 large-12 columns">
        <h2>Ideal Budget:</h2>
        <p>Monthly pay ($4,577) divided into what you should be spending in each category.</p>
      </div>
      <div class="small-12 medium-12 large-12 columns">
        <div id="graph-ideal"></div>
      </div>
    </div>

    <div class="row needs">
      <div class="small-12 medium-12 large-12 columns">
        <h2>Needs Total:</h2>
        <p>Adding each item in the needs category to find out what is being spend on average on necessities.</p>
      </div>
      <div class="small-12 medium-12 large-12 columns">
        <div id="graph-needs"></div>
      </div>
    </div>

    <div class="row actual">
      <div class="small-12 medium-12 large-12 columns">
        <h2>Actual Budget:</h2>
        <p>Taking the total amount spent on needs then figuring out if needs are under budget and what is left for wants and savings.</p>
      </div>
      <div class="small-12 medium-12 large-12 columns">
        <div id="graph-actual"></div>
      </div>
      <div class="small-12 medium-12 large-12 columns">
        <p><br />Needs are <strong>$1,759</strong> and <strong>38%</strong> over the ideal budget which leaves this family little room for items they may want like a car or a cell phone or having any money to put towards savings or debt repayment.</p>
      </div>
    </div>


    <!-- pattern definition for stripes in Needs graph --> 
    <svg height="10" width="10" xmlns="http://www.w3.org/2000/svg" version="1.1"> 
      <defs> 
        <pattern id="diagonal-stripe-2" patternUnits="userSpaceOnUse" width="10" height="10"> 
          <rect width='10' height='10' fill='#f8bc50'/>
          <path d='M-1,1 l2,-2
                   M0,10 l10,-10
                   M9,11 l2,-2' stroke='#fae9b8' stroke-width='2.5'/>
          </image> 
        </pattern> 
      </defs> 
    </svg>


    <script src="js/vendor/jquery.js"></script>
    <script src="js/vendor/what-input.js"></script>
    <script src="js/vendor/foundation.js"></script>
    <script src="js/app.js"></script>



    <script type="text/javascript">

      d3.csv("csv/data.csv", function(data) {

        console.log("from csv:", data);

        // read numerical values as numbers not strings
        data.forEach(function(d){ d['income'] = +d['income']; });
        data.forEach(function(d){ d['takehome'] = +d['takehome']; });
        data.forEach(function(d){ d['housing'] = +d['housing']; });
        data.forEach(function(d){ d['health'] = +d['health']; });
        data.forEach(function(d){ d['grocery'] = +d['grocery']; });
        data.forEach(function(d){ d['transit'] = +d['transit']; });
        data.forEach(function(d){ d['childcare'] = +d['childcare']; });
        data.forEach(function(d){ d['fifty'] = +d['fifty']; });
        data.forEach(function(d){ d['thirty'] = +d['thirty']; });
        data.forEach(function(d){ d['twenty'] = +d['twenty']; });
        data.forEach(function(d){ d['population'] = +d['population']; });
        data.forEach(function(d){ d['difference'] = +d['difference']; });





      // TODO: functionalize these next three... 

        // grab unique location values from csv data
        var unique = {};
        var distinct = [];
        for (var i in data) {
          if (typeof(unique[data[i].city]) == "undefined") {
            distinct.push(data[i].city);
          }
          unique[data[i].city] = 0;
        }

        // clear the locations dropdown
        $('#location option').each(function() {
          $(this).remove();
        });

        // populate locations dropdown with unique values
        var option = '';
        for (var i = 0; i < distinct.length; i++) {
          option += '<option value="' + distinct[i] + '">' + distinct[i] + '</option>';
        }
        $('#location').append(option);




        // grab unique household values from csv data
        var unique = {};
        var distinct = [];
        for (var i in data) {
          if (typeof(unique[data[i].household]) == "undefined") {
            distinct.push(data[i].household);
          }
          unique[data[i].household] = 0;
        }

        // clear the household dropdown
        $('#household option').each(function() {
          $(this).remove();
        });

        // populate household dropdown with unique values
        var option = '';
        for (var i = 0; i < distinct.length; i++) {
          option += '<option value="' + distinct[i] + '">' + distinct[i] + '</option>';
        }
        $('#household').append(option);





        // grab unique income level values from csv data
        var unique = {};
        var distinct = [];
        for (var i in data) {
          if (typeof(unique[data[i].level]) == "undefined") {
            distinct.push(data[i].level);
          }
          unique[data[i].level] = 0;
        }

        // clear the income level dropdown
        $('#level option').each(function() {
          $(this).remove();
        });

        // populate income level dropdown with unique values
        var option = '';
        for (var i = 0; i < distinct.length; i++) {
          option += '<option value="' + distinct[i] + '">' + distinct[i] + '</option>';
        }
        $('#level').append(option);









        // check value of dropdowns


        // select data row based on value




                data = data[0]; // kludge to select first object, needs to pull based on dropdowns


        // set derivative properties
        data.difference = data.income - 23850;
        data.fifty = Math.round(data.takehome * 0.5);
        data.thirty = Math.round(data.takehome * 0.3);
        data.twenty = Math.round(data.takehome * 0.2);
        data.needs = data.housing + data.health + data.grocery + data.transit + data.childcare;
        data.lo = data.takehome - data.needs;
        data.lowants = Math.round(data.lo * 0.6);
        data.losaves = Math.round(data.lo * 0.4);
        data.needsperc = Math.round((data.needs / data.takehome)*100);
        data.wantsperc = Math.round((data.lowants / data.takehome)*100);
        data.savesperc = Math.round((data.losaves / data.takehome)*100);
        data.overneeds = Math.round(data.needs - data.fifty);
        data.overneedsperc = (Math.round((data.needsperc - 0.5)*100))/100;

        console.log("processed:", data);

        // setup an array for each graph
        var dataideal = [
          [
            { x: 0, y: data.fifty, t1: "50%", t2: "Needs:" }
          ],
          [ 
            { x: 0, y: data.thirty, t1: "30%", t2: "Wants:"  }
          ],
          [
            { x: 0, y: data.twenty, t1: "20%", t2: "Saves:"  }
          ]
        ];

        console.log("ideal:", dataideal);


        var dataneeds = [
          [
              { x: 0, y: 0 },                          
              { x: 1, y: data.housing },              
              { x: 2, y: data.housing + data.health },               
              { x: 3, y: data.housing + data.health + data.grocery },               
              { x: 4, y: data.housing + data.health + data.grocery + data.transit }   
          ],
          [
              { section: "Housing & Utilities", icon: "housing.svg", x: 0, y: data.housing }, 
              { section: "Healthcare", icon: "health.svg", x: 1, y: data.health }, 
              { section: "Groceries", icon: "grocery.svg", x: 2, y: data.grocery }, 
              { section: "Transportation", icon: "transit.svg", x: 3, y: data.transit },
              { section: "Childcare", icon: "childcare.svg", x: 4, y: data.childcare } 
          ],
          [
              { x: 0, y: data.takehome - data.housing },
              { x: 1, y: data.takehome - data.housing - data.health },
              { x: 2, y: data.takehome - data.housing - data.health - data.grocery },
              { x: 3, y: data.takehome - data.housing - data.health - data.grocery - data.transit },
              { x: 4, y: data.takehome - data.housing - data.health - data.grocery - data.transit - data.childcare }  
          ]
        ];

        console.log("needs:", dataneeds);

        var dataactual = [
          [
            { x: 0, y: data.needs, t1: data.needsperc, t2: "Needs:" }
          ],
          [ 
            { x: 0, y: data.lowants, t1: data.wantsperc, t2: "Wants:"  }
          ],
          [
            { x: 0, y: data.losaves, t1: data.savesperc, t2: "Saves:"  }
          ]
        ];

        console.log("actual:", dataactual);

        // stack each array
        var stack = d3.layout.stack();
        stack(dataideal);
        stack(dataactual);
        stack(dataneeds);

        // set a few global dimenions
        var w = d3.select("div.row").node().getBoundingClientRect().width - 30;  // global width - pull from foundation row width
        var lineHeight = 220;               // global line height for solid lines

        // select first in a series - useful for appending lines
        d3.selection.prototype.first = function() {     
          return d3.select(this[0][0]);
        };

        // move selection to front
        d3.selection.prototype.moveToFront = function() {  
          return this.each(function(){
            this.parentNode.appendChild(this);
          });
        };

        // move selection to back
        d3.selection.prototype.moveToBack = function() {  
            return this.each(function() { 
                var firstChild = this.parentNode.firstChild; 
                if (firstChild) { 
                    this.parentNode.insertBefore(this, firstChild); 
                } 
            });
        };

        // draw all three graphs
        function drawAll() { 
          d3.selectAll("svg.graph").remove();
          drawIdeal();
          drawNeeds();
          drawActual();
        }

        drawAll(); 

        // http://stackoverflow.com/questions/16265123/resize-svg-when-window-is-resized-in-d3-js/21938056#21938056
        // https://chartio.com/resources/tutorials/how-to-resize-an-svg-when-the-window-is-resized-in-d3-js

        // DRAW IDEAL BUDGET GRAPH
        function drawIdeal() {

        var dataset = dataideal; 
        var h = 100; 

        // set up scales 
        var xScale = d3.scale.ordinal()      // actually y scale, since we're doing horizontal bars
          .domain(d3.range(dataset[0].length))
          .rangeRoundBands([0, h]);
      
        var yScale = d3.scale.linear()       // actually x scale
          .domain([0,       
            d3.max(dataset, function(d) {
              return d3.max(d, function(d) {
                return d.y0 + d.y;
              });
            })
          ])
          .range([0, w]);
          
          // create SVG element
          var svg = d3.select("#graph-ideal")
                .append("svg")
                .attr("class", "graph")
                .attr("width", w)        
                .attr("height", h+120);   // +120 is to open up vertical space for annotation
      
          // add a group for each row of data
          var groups = svg.selectAll("g")
            .data(dataset)
            .enter().append("g")
            .style("fill", function(d, i) {                  
              var fillColor;                                  
                if (i == 0) { fillColor = "#f8bc50";}         // yellow
                else if (i == 1) { fillColor = "#c66728";}    // orange
                else if (i == 2) { fillColor = "#ab4949";}    // red
              return fillColor;      
            });
      
          // add a rect for each data value
          var rects = groups.selectAll("rect")
            .data(function(d) { return d; })
            .enter().append("rect")
              .attr("x", function(d) { return yScale(d.y0); }) 
              .attr("y", 128)   // 128 is to shift chart down to make way for annotation
              .attr("width", function(d) { return yScale(d.y); })
              .attr("height", xScale.rangeBand());

          // draw a line over the start of each rect
          var lines = groups.selectAll("line")
            .data(function(d) { return d; })
            .enter().append("line")
            .attr("y1", 0) 
            .attr("y2", lineHeight) 
            .attr("x1", function(d) { return yScale(d.y0); }) 
            .attr("x2", function(d) { return yScale(d.y0); })        
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none");

          // add the last line at the end of the graph
          svg.append("line") 
            .attr("y1", 0) 
            .attr("y2", lineHeight) 
            .attr("x1", w-2)
            .attr("x2", w-2) 
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none");

          // fix the position of the first line of the graph
          var lineFix = svg.selectAll('line'); 
          lineFix.first()
            .attr('transform', 'translate(2,0)');

          // add label line 1
          var textLabelOne = svg.selectAll() // TODO: need to separate bold and regular text via tspans
            .data(dataset)
            .enter().append("text")
            .attr("class", "graph-label")
            .style("font-weight", 700)
            .attr("fill", "#231f20")
            .attr("dx", function(d) { return yScale(d[0].y0)+10; })  // position horizontally
            .attr("dy", "60")                                        // position vertically -- TODO: base these on type size?
            .text(function(d) { return d[0].t1; });

          var textLabelOneAyy = d3.selectAll(".graph-label")
            .append("tspan")
            .style("font-weight", 400)
            .text(function(d) { return " " + d[0].t2 })

          // add label line 2
          var textLabelTwo = svg.selectAll()
            .data(dataset)
            .enter().append("text")
            .attr("class", "graph-label")
            .attr("fill", "#231f20")
            .attr("dx", function(d) { return yScale(d[0].y0)+10; })  // position horizontally
            .attr("dy", "100")                                       // position vertically -- TODO: base these on type size?
            .text(function(d) { return "$" + d[0].y; });
        }

        // DRAW NEEDS GRAPH 
        function drawNeeds() {

          var h = 720; 
          var dataset = dataneeds;
          var bottomOffset = 34;


          // reset scales 
          var xScale = d3.scale.ordinal()              
            .domain(d3.range(dataset[0].length))
            .rangeRoundBands([0, h]); 

          var yScale = d3.scale.linear()               
            .domain([0,
              d3.max(dataset, function(d) {
                return d3.max(d, function(d) {
                  return d.y0 + d.y;
                });
              })
            ])
            .range([0, w]); 

          // create new svg element
          var svg = d3.select("#graph-needs")
            .append("svg")
            .attr("class", "graph")
            .attr("width", w)
            .attr("height", h);    

          // add background colors
          svg.append("rect")
            .attr("x", 0) 
            .attr("y", 0) 
            .attr("width", function(d) { return yScale(data.fifty); })
            .attr("height", h-bottomOffset)
            .style("fill", "#f8bc50")
            .style("fill-opacity", 0.18);

          svg.append("rect")
            .attr("x", function(d) { return yScale(data.fifty); }) 
            .attr("y", 0) 
            .attr("width", function(d) { return yScale(data.thirty); })
            .attr("height", h-bottomOffset)
            .style("fill", "#c66728")
            .style("fill-opacity", 0.18);

          svg.append("rect")
            .attr("x", function(d) { return yScale(data.fifty) + yScale(data.thirty); }) 
            .attr("y", 0) 
            .attr("width", function(d) { return yScale(data.twenty); })
            .attr("height", h-bottomOffset)
            .style("fill", "#ab4949")
            .style("fill-opacity", 0.18);

          // add a group for each row of data
          var groups = svg.selectAll("g")
            .data(dataset)
            .enter().append("g")
            .style("fill", function(d, i) {                   
              var fillColor;                                  
                if (i == 0) { fillColor = "#f8bc50" ;}         // solid yellow
                else if (i == 1) { fillColor = "url(#diagonal-stripe-2)" ;}    // pattern fill defined in svg in html
                else if (i == 2) { fillColor = "#e8e8e8" ;}    // gray
              return fillColor;      
            });

          // add a rect for each data value
          var rects = groups.selectAll("rect")
            .data(function(d) {return d;})
            .enter().append("rect")
            .attr("x", function(d) { return yScale(d.y0); })
            .attr("y", function(d, i) { return xScale(i)+50; })   // value adjusts vertical position of rects
            .attr("width", function(d) { return yScale(d.y); })
            .attr("height", 60);                                  // value sets height of each bar, no effect on position

          // first dashed line
          svg.append("line")
            .attr("y1", h-bottomOffset) 
            .attr("y2", 0) 
            .attr("x1", 2) 
            .attr("x2", 2) 
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // second dashed line - 50% of ideal budget
          svg.append("line")
            .attr("y1", h-bottomOffset) 
            .attr("y2", 0) 
            .attr("x1", function(d) { return yScale(data.fifty); })
            .attr("x2", function(d) { return yScale(data.fifty); })
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // third dashed line - next 30% of ideal budget
          svg.append("line")
            .attr("y1", h-bottomOffset) 
            .attr("y2", 0) 
            .attr("x1", function(d) { return yScale(data.fifty) + yScale(data.thirty); })
            .attr("x2", function(d) { return yScale(data.fifty) + yScale(data.thirty); })
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // fourth dashed line
          svg.append("line")
            .attr("y1", h-bottomOffset) 
            .attr("y2", 0) 
            .attr("x1", w-2)
            .attr("x2", w-2)
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // add a label to each row, indicating which value (housing, healthcare etc.) is being added to the cumulative total
          var textLabelOne = svg.selectAll("text")
            .data(dataset[1])
            .enter().append("text")
            .attr("y", function(d, i) { return xScale(i)+35; })     // value adjusts vertical position of labels
            .attr("x", function(d) { return yScale(d.y0)+32; })      // value adjusts horizontal position of labels
            .attr("fill", "#231f20")
            .attr("class", "needs-label")
            .text(function(d) { 
              if (d.section != null) { return d.section; } // only add label if 'section' exists in the object
              else { return null; }                                      // TODO: destroy the text element instead of return null
            })                                                           // also: maybe don't need this conditional anymore?

          var textLabelTwo = d3.selectAll(".needs-label")
            .append("tspan")
            .style("font-weight", 700)
            .text(function(d) { return " +$" + d.y })

          // add svg icons to text labels
          var icons = svg.selectAll("svg") 
            .data(dataset[1])                     // this now targets the second array in dataset, where caption info is stored
            .enter().append("svg:image")
            .attr("xlink:href", function(d) {
              if(d.icon != null) {                // TODO: probably don't need this conditional anymore
                return "img/" + d.icon; }
              else { return null; }
            })
            .attr("y", function(d, i) { return xScale(i)+16; })     
            .attr("x", function(d) { return yScale(d.y0)+6; })
            .attr("width", 20)      
            .attr("height", 20);

          // add below-the-bar icons 
          var subIcons = svg.selectAll("svg")
            .data(dataset[1])
            .enter().append("svg:image")    // first add one icon of each type
            .attr("class", "subicon")
            .attr("xlink:href", function(d) {
              if(d.icon != null) {
                return "img/grey-" + d.icon; }
              else { return null; }
            })
            .attr("y", function(d, i) { return xScale(i)+116; })                // vertical position below the relevant bar
            .attr("x", function(d) { return yScale(d.y0)+(yScale(d.y)/2)-10; }) // horizontal position in the middle of the relevant bar
            .attr("width", 20)      
            .attr("height", 20)
            .each(function(d,i) {           // then add a corresponding icon for each remaining bar
              for (n=i; n<4; n++) {
                svg.selectAll("svg")
                  .data([d])
                  .enter().append("svg:image")
                  .attr("class", "subicon")
                  .attr("xlink:href", "img/grey-" + d.icon)
                  .attr("y", function(d, i) { return xScale(i)+260+(n*144); })  // vert - 260 is 116 + 144 (height of bar etc.)
                  .attr("x", function(d) { return yScale(d.y0)+(yScale(d.y)/2)-10; }) // horz - same as above
                  .attr("width", 20)      
                  .attr("height", 20);
              }
            });
        }

        // DRAW ACTUAL BUDGET GRAPH
        function drawActual() {

          var dataset = dataactual;
          var h = 100; 
          var barOffset = 160;

          // reset scales 
          var xScale = d3.scale.ordinal()
            .domain(d3.range(dataset[0].length))
            .rangeRoundBands([0, h]);
        
          var yScale = d3.scale.linear()
            .domain([0,       
              d3.max(dataset, function(d) {
                return d3.max(d, function(d) {
                  return d.y0 + d.y;
                });
              })
            ])
            .range([0, w]);

          // create SVG element
          var svg = d3.select("#graph-actual")
                .append("svg")
                .attr("class", "graph ok")
                .attr("width", w)         
                .attr("height", h+240);   // +240 opens up vertical space for annotation
      
          // add a group for each row of data
          var groups = svg.selectAll("g")
            .data(dataset)
            .enter().append("g")
            .style("fill", function(d, i) {                   
              var fillColor;                                  
                if (i == 0) { fillColor = "#f8bc50";}         // yellow
                else if (i == 1) { fillColor = "#c66728";}    // orange
                else if (i == 2) { fillColor = "#ab4949";}    // red
              return fillColor;      
            });
      
          // add a rect for each data value
          var rects = groups.selectAll("rect")
            .data(function(d) { return d; })
            .enter().append("rect")
              .attr("x", function(d) { return yScale(d.y0); })
              .attr("y", barOffset)    // set vertical position of bar inside svg
              .attr("width", function(d) { return yScale(d.y); })
              .attr("height", xScale.rangeBand());


          // draw a line over the start of every rect
          var lines = groups.selectAll("line")
            .data(function(d) { return d; })
            .enter().append("line")
            .attr("x1", function(d) { return yScale(d.y0); }) 
            .attr("x2", function(d) { return yScale(d.y0); })        
            .attr("y1", barOffset)  // top of line
            .attr("y2", barOffset+h)  
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none");

          // fix the position of the first line of the graph
          var lineFix = svg.selectAll('line'); 
          lineFix.first()
            .attr('transform', 'translate(2,0)');

          // add the last line at the end of the graph
          svg.append("line")
            .attr("x1", w-2) 
            .attr("x2", w-2) 
            .attr("y1", barOffset) 
            .attr("y2", barOffset+h) 
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none");


          var dashedHeight = 80;

          // add dashed lines
          svg.append("line")
            .attr("y1", barOffset-60)   // 60 extends dashed line above bar
            .attr("y2", barOffset+140) // 240 extends dashed line to bottom of svg
            .attr("x1", 2) 
            .attr("x2", 2) 
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // second dashed line
          svg.append("line")
            .attr("y1", barOffset-60)   // 60 extends dashed line above bar
            .attr("y2", barOffset+140) // 240 extends dashed line to bottom of svg
            .attr("x1", function(d) { return yScale(data.fifty); })
            .attr("x2", function(d) { return yScale(data.fifty); })
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // third dashed line
          svg.append("line")
            .attr("y1", barOffset-60)   // 60 extends dashed line above bar
            .attr("y2", barOffset+140) // 240 extends dashed line to bottom of svg
            .attr("x1", function(d) { return yScale(data.fifty) + yScale(data.thirty); })
            .attr("x2", function(d) { return yScale(data.fifty) + yScale(data.thirty); })
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // fourth dashed line
          svg.append("line")
            .attr("y1", barOffset-60)   // 60 extends dashed line above bar
            .attr("y2", barOffset+140) // 240 extends dashed line to bottom of svg
            .attr("x1", w-2)
            .attr("x2", w-2)
            .style("stroke-width", 4)
            .style("stroke", "white")
            .style("fill", "none")
            .style("stroke-dasharray", ("4, 8"));

          // add label line 1
          var textLabelOne = groups.selectAll("text") // TODO: need to separate bold and reg trext via tspans
            .data(function(d) { return d; })
            .enter().append("text")
              .attr("class", "actual-label")
              .style("font-weight", 700)
              .attr("fill", "#231f20")
              .attr("dx", function(d) { return yScale(d.y0)+10; })    // position horizontally
              .attr("dy", barOffset - 60)                             // position vertically
              .text(function(d) { return d.t1; });

          var textLabelTwo = d3.selectAll(".actual-label")
            .append("tspan")
            .style("font-weight", 400)
            .text(function(d) { return "% " + d.t2 });

          var textLabelThree = d3.selectAll(".actual-label")
            .append("tspan")
            .attr("class", "labelThree")
            .attr("x", function(d) { return yScale(d.y0)+10; })
            .attr("dy", 36)
            .style("font-weight", 400)
            .text(function(d) { return "$" + d.y });

          arrangeLabels();

        }





        // WIP re-arrange labels to prevent overlap -- TODO: adapt this to shift labels left, connect to rect with line
        function arrangeLabels() {
          var move = 1;
          while(move > 0) {
            move = 0;
            d3.selectAll(".actual-label")
               .each(function() {
                 var that = this,
                     a = this.getBoundingClientRect(); // bounding box of current label
                 d3.selectAll(".actual-label")
                    .each(function() {
                      if(this != that) {
                        var b = this.getBoundingClientRect(); // bounding box of label to compare to current label

                        if((Math.abs(a.left - b.left) * 2 < (a.width + b.width)) &&
                           (Math.abs(a.top - b.top) * 2 < (a.height + b.height))) { // hit detection...

                          d3.select(this).attr("transform", "translate(" + -104 + "," + -72 + ")"); // move labels up and left
                          d3.select(that).attr("transform", "translate(" + -208 + "," + -36 + ")");

                          var c = this.getBoundingClientRect();
                          var d = that.getBoundingClientRect();

                          d3.select("svg.ok") // draw horizontal line for 3rd label
                            .append("line")
                            .attr("x1", c.right-92) 
                            .attr("x2", c.right-32) 
                            .attr("y1", 54)
                            .attr("y2", 54) 
                            .style("stroke-width", 4)
                            .style("stroke", "#231f20")
                            .style("fill", "none");

                          d3.select("svg.ok") // draw vertical line
                            .append("line")
                            .attr("x1", c.right-34)
                            .attr("x2", c.right-34) 
                            .attr("y1", 54)
                            .attr("y2", 140) 
                            .style("stroke-width", 4)
                            .style("stroke", "#231f20")
                            .style("fill", "none");

                          d3.select("svg.ok") // draw horizontal line for 2nd label
                            .append("line")
                            .attr("x1", d.right-92) 
                            .attr("x2", d.right+86) 
                            .attr("y1", 90)
                            .attr("y2", 90) 
                            .style("stroke-width", 4)
                            .style("stroke", "#231f20")
                            .style("fill", "none");

                          d3.select("svg.ok") // draw vertical line
                            .append("line")
                            .attr("x1", d.right+84)
                            .attr("x2", d.right+84) 
                            .attr("y1", 90)
                            .attr("y2", 140) 
                            .style("stroke-width", 4)
                            .style("stroke", "#231f20")
                            .style("fill", "none");

                            // this is all obviously tuned, only works at certain widths
                            // need a way to carry the original positional information 
                            // forward into this function to correctly target the rect

                        }
                      }
                    });
               });
          }
        }
      });





    </script>


<!-- 

      still to do: 
        fix labeling layout on actual budget
        map all text numbers to data points, most are currently static...
        object type, data input (csv?) and city / household selection

-->



  </body>
</html>
